<!doctype html>
<html>
  <head>
    <title>Bot Test Dashboard</title>
    <style>
      .toggle-group {
        margin-top: 15px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background: #fff;
      }
      label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>My Bot Dashboard</h1>
    <div id="status">Checking login...</div>
    <button id="loginBtn" style="display: none">Login with Discord</button>

    <div id="settingsArea" style="display: none">
      <hr />
      <h3>Welcome Back!</h3>
      <div
        style="
          display: flex;
          align-items: center;
          gap: 15px;
          margin-bottom: 10px;
        "
      >
        <img id="userAvatar" src="" style="width: 50px; border-radius: 50%" />
        <h3 style="margin: 0">
          Welcome Back, <span id="userName">User</span>!
        </h3>
      </div>
      <p>User ID: <span id="displayUserId"></span></p>

      <div
        id="statsDisplay"
        style="background: #f4f4f4; padding: 15px; border-radius: 8px"
      >
        <h4>Your Game Stats</h4>
        <p>
          üêç Snake Wins: <b id="snWins">0</b>
          <button onclick="resetScore('sn_wins', 'Snake')">Reset</button>
        </p>
        <p>
          ‚ùå Tic-Tac-Toe Wins: <b id="tttWins">0</b>
          <button onclick="resetScore('ttt_wins', 'Tic-Tac-Toe')">Reset</button>
        </p>
        <p>
          ‚úÇÔ∏è RPS Wins: <b id="rpsWins">0</b>
          <button onclick="resetScore('rps_wins', 'RPS')">Reset</button>
        </p>
        <p>
          üß† Memory Matching Wins: <b id="mmWins">0</b>
          <button onclick="resetScore('mm_wins', 'Memory Matching')">
            Reset
          </button>
        </p>
      </div>

      <div class="toggle-group">
        <h4>Privacy & AI Settings</h4>
        <label
          ><input
            type="checkbox"
            id="sn_hidden"
            onclick="toggleOption('sn_hidden')"
          />
          Hide Snake Score</label
        >
        <label
          ><input
            type="checkbox"
            id="ttt_hidden"
            onclick="toggleOption('ttt_hidden')"
          />
          Hide Tic-Tac-Toe Score</label
        >
        <label
          ><input
            type="checkbox"
            id="rps_hidden"
            onclick="toggleOption('rps_hidden')"
          />
          Hide RPS Score</label
        >
        <label
          ><input
            type="checkbox"
            id="mm_hidden"
            onclick="toggleOption('mm_hidden')"
          />
          Hide Memory Score</label
        >
        <label
          ><input
            type="checkbox"
            id="dm_reply"
            onclick="toggleOption('dm_reply')"
          />
          Enable AI DM Replies</label
        >
      </div>

      <div
        id="adminArea"
        style="margin-top: 20px; border-top: 2px solid #ddd; padding-top: 10px"
      >
        <h4>Guild Settings (Admin Only)</h4>
        <div
          id="guildSelectorArea"
          style="
            display: none;
            margin-bottom: 10px;
            align-items: center;
            gap: 10px;
          "
        >
          <img
            id="guildIcon"
            src=""
            style="
              width: 32px;
              border-radius: 50%;
              vertical-align: middle;
              display: none;
            "
          />
          <label>Select Server: </label>
          <select id="guildSelect" onchange="updateSelectedGuild()"></select>
        </div>

        <div id="prefixControls" style="display: none">
          <label>Server Prefix:</label>
          <input
            type="text"
            id="prefixInput"
            maxlength="3"
            style="width: 40px"
          />
          <button onclick="savePrefix()">Save Prefix</button>
          <p id="saveStatus"></p>
        </div>
        <p id="adminStatus">Checking permissions...</p>
      </div>

      <br />
      <button
        onclick="logout()"
        style="
          background-color: #ff4444;
          color: white;
          border: none;
          padding: 10px;
          cursor: pointer;
        "
      >
        Log Out
      </button>
    </div>

    <script>
      const TUNNEL_URL = "https://instructively-hushful-cinda.ngrok-free.dev";
      const DISCORD_LOGIN_URL =
        "https://discord.com/oauth2/authorize?client_id=1048675302722768896&response_type=code&redirect_uri=https%3A%2F%2Freaperwatch.github.io%2FThe-Lunar-Archive%2Fdashboard.html&scope=identify%20guilds";

      let allAdminGuilds = []; // Local cache for guild data

      function logout() {
        localStorage.removeItem("session");
        window.location.href = window.location.pathname;
      }

      async function toggleOption(key) {
        const token = localStorage.getItem("session");
        try {
          await fetch(`${TUNNEL_URL}/api/toggle-setting`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: token,
              "ngrok-skip-browser-warning": "true",
            },
            body: JSON.stringify({ settingKey: key }),
          });
        } catch (err) {
          alert("Failed to update setting.");
        }
      }

      function updateSelectedGuild() {
        const select = document.getElementById("guildSelect");
        const guildId = select.value;
        const guild = allAdminGuilds.find((g) => g.id === guildId);

        if (guild) {
          window.currentGuildId = guild.id;
          document.getElementById("prefixInput").value = guild.prefix;
          document.getElementById("prefixControls").style.display = "block";
          document.getElementById("saveStatus").innerText = "";

          // Update the server icon next to the dropdown
          const iconImg = document.getElementById("guildIcon");
          if (guild.icon) {
            iconImg.src = guild.icon;
            iconImg.style.display = "inline";
          } else {
            iconImg.style.display = "none";
          }
        }
      }

      async function savePrefix() {
        const token = localStorage.getItem("session");
        const status = document.getElementById("saveStatus");
        const newPrefix = document.getElementById("prefixInput").value;
        try {
          const response = await fetch(`${TUNNEL_URL}/api/save-prefix`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: token,
              "ngrok-skip-browser-warning": "true",
            },
            body: JSON.stringify({
              guildId: window.currentGuildId,
              newPrefix: newPrefix,
            }),
          });
          if (response.ok) {
            status.innerText = "‚úÖ Updated!";
            const guild = allAdminGuilds.find(
              (g) => g.id === window.currentGuildId,
            );
            if (guild) guild.prefix = newPrefix;
          } else {
            status.innerText = "‚ùå Error.";
          }
        } catch (err) {
          status.innerText = "‚ùå Offline.";
        }
      }

      async function resetScore(gameKey, gameName) {
        const confirmReset = confirm(
          `‚ö†Ô∏è WARNING: Are you sure you want to reset your ${gameName} wins?\n\nThis action is NOT reversible!`,
        );

        if (!confirmReset) return;

        const token = localStorage.getItem("session");
        try {
          const response = await fetch(`${TUNNEL_URL}/api/reset-score`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: token,
              "ngrok-skip-browser-warning": "true",
            },
            body: JSON.stringify({ gameKey: gameKey }),
          });

          if (response.ok) {
            alert(`${gameName} wins have been reset to 0.`);
            location.reload(); // Refresh to show the updated 0 score
          } else {
            alert("Failed to reset score.");
          }
        } catch (err) {
          alert("Error connecting to server.");
        }
      }

      window.onload = async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get("code");
        const token = localStorage.getItem("session");

        if (code) {
          const res = await fetch(`${TUNNEL_URL}/api/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ code }),
          });
          const data = await res.json();
          if (data.token) {
            localStorage.setItem("session", data.token);
            window.location.href = window.location.pathname;
          }
        } else if (token) {
          fetch(`${TUNNEL_URL}/api/get-settings`, {
            headers: {
              Authorization: token,
              "ngrok-skip-browser-warning": "true",
            },
          })
            .then((res) => res.json())
            .then((data) => {
              document.getElementById("status").style.display = "none";
              document.getElementById("settingsArea").style.display = "block";

              // Set User Metadata
              document.getElementById("userName").innerText = data.username;
              document.getElementById("userAvatar").src = data.avatar;
              document.getElementById("displayUserId").innerText = data.userId;

              // Set Game Stats
              document.getElementById("snWins").innerText = data.stats.sn_wins;
              document.getElementById("tttWins").innerText =
                data.stats.ttt_wins;
              document.getElementById("rpsWins").innerText =
                data.stats.rps_wins;
              document.getElementById("mmWins").innerText = data.stats.mm_wins;

              // Set Checkbox states
              document.getElementById("sn_hidden").checked =
                data.stats.sn_hidden;
              document.getElementById("ttt_hidden").checked =
                data.stats.ttt_hidden;
              document.getElementById("rps_hidden").checked =
                data.stats.rps_hidden;
              document.getElementById("mm_hidden").checked =
                data.stats.mm_hidden;
              document.getElementById("dm_reply").checked = data.stats.dm_reply;

              // Server Dropdown
              if (data.adminGuilds?.length > 0) {
                allAdminGuilds = data.adminGuilds;
                const select = document.getElementById("guildSelect");
                select.innerHTML = "";
                data.adminGuilds.forEach((guild) => {
                  const opt = document.createElement("option");
                  opt.value = guild.id;
                  opt.innerText = guild.name;
                  select.appendChild(opt);
                });
                document.getElementById("guildSelectorArea").style.display =
                  "flex";
                document.getElementById("adminStatus").innerText =
                  "Managing your servers:";
                updateSelectedGuild();
              } else {
                document.getElementById("adminStatus").innerText =
                  "No admin servers found.";
              }
            })
            .catch(() => {
              document.getElementById("status").innerText = "Bot is offline.";
            });
        } else {
          document.getElementById("status").innerText = "Please log in.";
          document.getElementById("loginBtn").style.display = "block";
          document.getElementById("loginBtn").onclick = () =>
            (window.location.href = DISCORD_LOGIN_URL);
        }
      };
    </script>
  </body>
</html>
