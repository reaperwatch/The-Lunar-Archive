<!doctype html>
<html>
  <head>
    <title>Bot Test Dashboard</title>
  </head>
  <body>
    <h1>My Bot Dashboard</h1>
    <div id="status">Checking login...</div>
    <button id="loginBtn" style="display: none">Login with Discord</button>

    <script>
      const TUNNEL_URL = "https://instructively-hushful-cinda.ngrok-free.dev";
      const DISCORD_LOGIN_URL =
        "https://discord.com/oauth2/authorize?client_id=1048675302722768896&response_type=code&redirect_uri=https%3A%2F%2Freaperwatch.github.io%2FThe-Lunar-Archive%2Fdashboard.html&scope=identify";

      window.onload = async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get("code");

        if (code) {
          document.getElementById("status").innerText = "Verifying with Bot...";

          // 5 mins ID sent to bot for verification
          try {
            const response = await fetch(`${TUNNEL_URL}/api/login`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ code: code }),
            });
            const data = await response.json();

            if (data.token) {
              localStorage.setItem("session", data.token);
              document.getElementById("status").innerText =
                `Logged in as ${data.username}!`;
              // Clean the URL
              window.history.replaceState(
                {},
                document.title,
                window.location.pathname,
              );
            }
          } catch (err) {
            document.getElementById("status").innerText =
              "Error connecting to Bot. Is ngrok running?";
          }
        } else {
          const token = localStorage.getItem("session");
          if (!token) {
            document.getElementById("status").innerText = "Please log in.";
            document.getElementById("loginBtn").style.display = "block";
            document.getElementById("loginBtn").onclick = () =>
              (window.location.href = DISCORD_LOGIN_URL);
          } else {
            document.getElementById("status").innerText =
              "Welcome back! Session found.";
          }
        }
      };
    </script>
  </body>
</html>
