<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Manage your bot data, privacy settings, and game stats via the dashboard."
    />
    <meta property="og:title" content="Bot Dashboard ‚Äî The Lunar Archive" />
    <meta
      property="og:description"
      content="Manage your bot data, privacy settings, and game stats via the dashboard."
    />
    <meta property="og:image" content="" />
    <meta property="og:type" content="website" />
    <meta
      property="og:url"
      content="https://reaperwatch.github.io/The-Lunar-Archive/dashboard.html"
    />
    <meta name="theme-color" content="#cb686b" />

    <title>Bot Dashboard ‚Äî The Lunar Archive</title>
    <link rel="stylesheet" href="bot-style.css" />
    <link
      rel="shortcut icon"
      href="https://reaperwatch.github.io/favicon.ico"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="https://reaperwatch.github.io/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="https://reaperwatch.github.io/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="https://reaperwatch.github.io/favicon-16x16.png"
    />
    <link
      rel="manifest"
      href="https://reaperwatch.github.io/site.webmanifest"
    />
    <link
      rel="sitemap"
      type="application/xml"
      title="Sitemap"
      href="https://reaperwatch.github.io/sitemap.xml"
    />
    <style>
      :root {
        --primary: #6dd3c4;
        --bg-dark: #071022;
        --card-bg: #0f1720;
        --text: #e0e0e0;
        --accent: #b39dff;
      }

      body {
        background:
          radial-gradient(
            circle at 12% 18%,
            rgba(109, 211, 196, 0.08) 0%,
            rgba(179, 157, 255, 0.06) 18%,
            transparent 36%
          ),
          radial-gradient(ellipse at bottom, #0f1720 0%, #071022 100%);
        color: var(--text);
        font-family: "Inter", sans-serif;
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding: 40px 20px;
        min-height: 100vh;
      }

      .container {
        max-width: 800px;
        width: 95%;
        margin: 0 12px;
        box-sizing: border-box;
        background:
          linear-gradient(
            180deg,
            rgba(255, 255, 255, 0.015),
            rgba(255, 255, 255, 0.01)
          ),
          rgba(15, 23, 32, 0.55);
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 12px 40px rgba(3, 6, 10, 0.6);
        border: 1px solid rgba(109, 211, 196, 0.12);
        backdrop-filter: blur(6px);
      }

      h1,
      h3,
      h4 {
        color: var(--primary);
        margin-top: 0;
      }

      #status {
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        text-align: center;
      }

      .user-profile {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        background: rgba(0, 0, 0, 0.2);
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.03);
        padding: 15px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }

      .stat-card b {
        color: var(--accent);
        font-size: 1.2rem;
      }

      .toggle-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        background: rgba(0, 0, 0, 0.2);
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
      }

      label {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        font-size: 0.9rem;
      }

      button {
        background: var(--primary);
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        transition: opacity 0.2s;
        font-weight: 600;
      }

      button:hover {
        opacity: 0.8;
      }

      .back-links {
        text-align: center;
        margin: 16px 0;
      }

      .back-button {
        display: inline-block;
        background: transparent;
        color: var(--accent);
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 10px 14px;
        border-radius: 8px;
        margin: 6px;
        font-weight: 700;
        text-decoration: none;
        font-size: 1rem;
      }

      .back-button:hover {
        background: rgba(255, 255, 255, 0.03);
      }

      .reset-btn {
        background: transparent;
        border: 1px solid #ff4444;
        color: #ff4444;
        font-size: 0.7rem;
        padding: 4px 8px;
        margin-top: 10px;
        align-self: flex-start;
      }

      .reset-btn:hover {
        background: #ff4444;
        color: white;
      }

      select,
      input[type="text"] {
        background: #3a2a2a;
        border: 1px solid var(--primary);
        color: white;
        padding: 8px;
        border-radius: 5px;
      }

      hr {
        border: 0;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        margin: 30px 0;
      }

      #loginBtn {
        display: block;
        margin: 20px auto;
        font-size: 1.1rem;
        padding: 12px 24px;
      }

      .site-footer {
        width: 100%;
        max-width: 800px;
        box-sizing: border-box;
        text-align: center;
        margin-top: 12px;
        color: rgba(224, 224, 224, 0.85);
        padding: 6px 12px;
      }

      /* Mobile responsiveness */
      @media (max-width: 600px) {
        body {
          padding: 18px 12px;
        }

        .container {
          padding: 18px;
        }

        header h1 {
          font-size: 1.5rem;
          text-align: center;
        }

        #status {
          padding: 12px;
          font-size: 0.95rem;
        }

        .user-profile {
          flex-direction: row;
          gap: 12px;
          padding: 10px;
        }

        #userAvatar {
          width: 48px !important;
          height: 48px !important;
        }

        .stats-grid {
          grid-template-columns: 1fr;
          gap: 12px;
        }

        .stat-card {
          padding: 12px;
        }

        .stat-card b {
          font-size: 1rem;
        }

        .toggle-group {
          grid-template-columns: 1fr;
          padding: 12px;
          gap: 10px;
        }

        label {
          font-size: 0.95rem;
        }

        button,
        .reset-btn,
        .back-button {
          padding: 10px 14px;
          font-size: 1rem;
        }

        .back-links .back-button {
          display: block;
          width: 100%;
          max-width: 420px;
          margin: 6px auto;
          box-sizing: border-box;
        }

        #loginBtn {
          width: 100%;
          padding: 12px;
        }

        .site-footer {
          padding: 8px 10px;
          font-size: 0.85rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Jetstream sam2967 Dashboard</h1>
        <div id="status">Checking login...</div>
        <button id="loginBtn" style="display: none">Login with Discord</button>
      </header>

      <div class="back-links">
        <a href="index.html" class="back-button">‚Üê Back to Home</a>
        <a href="bot.html" class="back-button">‚Üê Back to Bot</a>
      </div>

      <div id="settingsArea" style="display: none">
        <div class="user-profile">
          <img
            id="userAvatar"
            src=""
            style="
              width: 60px;
              border-radius: 50%;
              border: 2px solid var(--primary);
            "
          />
          <div
            style="
              display: flex;
              flex-direction: column;
              justify-content: center;
              align-items: center;
            "
          >
            <h3 style="margin: 0">Welcome, <span id="userName">User</span>!</h3>
            <small style="opacity: 0.7"
              >ID: <span id="displayUserId"></span
            ></small>
          </div>
        </div>

        <h4>Your Game Stats</h4>
        <div class="stats-grid">
          <div class="stat-card">
            <span>üêç Snake Wins</span>
            <b id="snWins">0</b>
            <button class="reset-btn" onclick="resetScore('sn_wins', 'Snake')">
              Reset
            </button>
          </div>
          <div class="stat-card">
            <span>‚ùå Tic-Tac-Toe</span>
            <b id="tttWins">0</b>
            <button
              class="reset-btn"
              onclick="resetScore('ttt_wins', 'Tic-Tac-Toe')"
            >
              Reset
            </button>
          </div>
          <div class="stat-card">
            <span>‚úÇÔ∏è RPS Wins</span>
            <b id="rpsWins">0</b>
            <button class="reset-btn" onclick="resetScore('rps_wins', 'RPS')">
              Reset
            </button>
          </div>
          <div class="stat-card">
            <span>üß† Memory</span>
            <b id="mmWins">0</b>
            <button
              class="reset-btn"
              onclick="resetScore('mm_wins', 'Memory Matching')"
            >
              Reset
            </button>
          </div>
          <div class="stat-card">
            <span>üî§ Word Scramble</span>
            <b id="wsWins">0</b>
            <button
              class="reset-btn"
              onclick="resetScore('ws_wins', 'Word Scramble')"
            >
              Reset
            </button>
          </div>
          <div class="stat-card">
            <span>üî¥ Connect Four</span>
            <b id="c4Wins">0</b>
            <button
              class="reset-btn"
              onclick="resetScore('c4_wins', 'Connect Four')"
            >
              Reset
            </button>
          </div>
        </div>

        <h4>Privacy & AI Settings</h4>
        <div class="toggle-group">
          <label
            ><input
              type="checkbox"
              id="sn_hidden"
              onclick="toggleOption('sn_hidden')"
            />
            Hide Snake</label
          >
          <label
            ><input
              type="checkbox"
              id="ttt_hidden"
              onclick="toggleOption('ttt_hidden')"
            />
            Hide Tic-Tac-Toe</label
          >
          <label
            ><input
              type="checkbox"
              id="rps_hidden"
              onclick="toggleOption('rps_hidden')"
            />
            Hide RPS</label
          >
          <label
            ><input
              type="checkbox"
              id="mm_hidden"
              onclick="toggleOption('mm_hidden')"
            />
            Hide Memory</label
          >
          <label
            ><input
              type="checkbox"
              id="ws_hidden"
              onclick="toggleOption('ws_hidden')"
            />
            Hide Word Scramble</label
          >
          <label
            ><input
              type="checkbox"
              id="c4_hidden"
              onclick="toggleOption('c4_hidden')"
            />
            Hide Connect Four</label
          >
          <label
            style="grid-column: span 2; margin-top: 10px; color: var(--accent)"
          >
            <input
              type="checkbox"
              id="dm_reply"
              onclick="toggleOption('dm_reply')"
            />
            Enable AI DM Replies
          </label>
        </div>

        <hr />

        <div id="adminArea">
          <h4>Server Management</h4>
          <div
            id="guildSelectorArea"
            style="
              display: none;
              margin-bottom: 20px;
              align-items: center;
              gap: 15px;
              background: rgba(0, 0, 0, 0.2);
              padding: 15px;
              border-radius: 8px;
            "
          >
            <img
              id="guildIcon"
              src=""
              style="width: 40px; border-radius: 50%; display: none"
            />
            <div style="flex-grow: 1">
              <label style="margin-bottom: 5px"
                >Select Server <br />
                (owner/admin)</label
              >
              <select
                id="guildSelector"
                style="width: 100%"
                onchange="
                  updateSelectedGuild();
                  loadCommands();
                "
              ></select>
            </div>
          </div>

          <div id="commandManagement" style="margin-top: 20px">
            <h3>Command Management</h3>
            <p>Enable or disable slash commands for this server.</p>
            <hr />
            <div
              id="commandsList"
              style="display: flex; flex-direction: column; gap: 10px"
            >
              <p>Select a server to view commands...</p>
            </div>
          </div>

          <div
            id="prefixControls"
            style="
              display: none;
              background: rgba(0, 0, 0, 0.2);
              padding: 15px;
              border-radius: 8px;
            "
          >
            <label>Server Prefix</label>
            <div style="display: flex; gap: 10px; margin-top: 10px">
              <input
                type="text"
                id="prefixInput"
                maxlength="2"
                style="width: 60px; text-align: center"
              />
              <button onclick="savePrefix()">Save Prefix</button>
            </div>
            <p id="saveStatus" style="font-size: 0.8rem; margin-top: 10px"></p>
          </div>
          <p id="adminStatus" style="font-size: 0.9rem; opacity: 0.8"></p>
        </div>

        <div style="margin-top: 40px; text-align: center">
          <button
            onclick="logout()"
            style="
              background-color: transparent;
              border: 1px solid #ff4444;
              color: #ff4444;
            "
          >
            Log Out
          </button>
        </div>
      </div>
    </div>
    <footer class="site-footer" style="text-align: center; margin-top: 12px">
      <small style="font-size: 0.9rem">
        <span>Made by slashing__moon ‚Ä¢ The Lunar Archive</span>
      </small>
    </footer>

    <script>
      async function handle(res) {
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.error || `Error ${res.status}`);
        }
        return res.json();
      }
      const TUNNEL_URL = "https://instructively-hushful-cinda.ngrok-free.dev";
      const DISCORD_LOGIN_URL =
        "https://discord.com/oauth2/authorize?client_id=1048675302722768896&response_type=code&redirect_uri=https%3A%2F%2Freaperwatch.github.io%2FThe-Lunar-Archive%2Fdashboard.html&scope=identify%20guilds";

      let allAdminGuilds = [];

      function logout() {
        localStorage.removeItem("session");
        window.location.href = window.location.pathname;
      }

      async function toggleOption(key) {
        const token = localStorage.getItem("session");
        const checkbox = document.getElementById(key);

        try {
          const response = await fetch(`${TUNNEL_URL}/api/toggle-setting`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-requested-with": "TheLunarArchive-Dashboard",
              Authorization: token,
              "ngrok-skip-browser-warning": "true",
            },
            body: JSON.stringify({ settingKey: key }),
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            const errorMessage = errorData.error || "Failed to update setting.";
            throw new Error(errorMessage);
          }
        } catch (err) {
          alert(`‚õî Error: ${err.message}`);
          // Revert the checkbox state on any failure
          if (checkbox) checkbox.checked = !checkbox.checked;
        }
      }

      function updateSelectedGuild() {
        const select = document.getElementById("guildSelector");
        const guildId = select.value;
        const guild = allAdminGuilds.find((g) => g.id === guildId);

        if (guild) {
          window.currentGuildId = guild.id;
          document.getElementById("prefixInput").value = guild.prefix;
          document.getElementById("prefixControls").style.display = "block";
          document.getElementById("saveStatus").innerText = "";
          const iconImg = document.getElementById("guildIcon");
          if (guild.icon) {
            iconImg.src = guild.icon;
            iconImg.style.display = "inline";
          } else {
            iconImg.style.display = "none";
          }
        }
      }

      async function savePrefix() {
        const token = localStorage.getItem("session");
        const status = document.getElementById("saveStatus");
        const newPrefix = document.getElementById("prefixInput").value;
        status.innerText = "üíæ Saving...";
        try {
          const response = await fetch(`${TUNNEL_URL}/api/save-prefix`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-requested-with": "TheLunarArchive-Dashboard",
              Authorization: token,
              "ngrok-skip-browser-warning": "true",
            },
            body: JSON.stringify({
              guildId: window.currentGuildId,
              newPrefix: newPrefix,
            }),
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || "An unknown error occurred.");
          }

          status.innerText = "‚úÖ Updated!";
          const guild = allAdminGuilds.find(
            (g) => g.id === window.currentGuildId,
          );
          if (guild) guild.prefix = newPrefix;
        } catch (err) {
          status.innerText = `‚ùå Error: ${err.message}`;
        }
      }

      function displayCommands(commands) {
        const listEl = document.getElementById("commandsList");

        listEl.innerHTML = "";

        if (!commands || commands.length === 0) {
          listEl.innerHTML = "<p>No commands found for this server.</p>";
          return;
        }

        commands.forEach((cmd) => {
          const div = document.createElement("div");
          div.className = "commandslist";

          div.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #444;">
                <div>
                    <strong style="color: #cb686b;">/${cmd.name}</strong>
                    <p style="margin: 0; font-size: 0.9em; color: #ccc;">${cmd.description || "No description provided."}</p>
                </div>
                <button 
                    onclick="toggleCommand('${cmd.name}', ${cmd.enabled})"
                    style="background: ${cmd.enabled ? "#43b581" : "#f04747"}; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;"
                >
                    ${cmd.enabled ? "Enabled" : "Disabled"}
                </button>
            </div>
        `;
          listEl.appendChild(div);
        });
      }

      async function loadCommands() {
        const guildSelector = document.getElementById("guildSelector");

        if (!guildSelector || !guildSelector.value) {
          console.warn("Guild selector not ready. Skipping loadCommands.");
          return;
        }

        const guildId = guildSelector.value;
        const sessionData = localStorage.getItem("session");
        let session;
        try {
          session = JSON.parse(sessionData);
        } catch (e) {
          session = { token: sessionData };
        }
        const listEl = document.getElementById("commandsList");

        if (!guildId) return;
        listEl.innerHTML = "<p>Loading commands...</p>";

        try {
          const response = await fetch(
            `${TUNNEL_URL}/api/commands/${guildId}`,
            {
              headers: {
                Authorization: session.token,
                "x-requested-with": "TheLunarArchive-Dashboard",
                "ngrok-skip-browser-warning": "true",
              },
            },
          );

          if (!response.ok) {
            throw new Error(`Server responded with ${response.status}`);
          }

          const data = await response.json();

          const commands = data.commands || [];

          displayCommands(commands);
          if (data.success && data.commands.length > 0) {
            listEl.innerHTML = data.commands
              .map(
                (cmd) => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; background:#f9f9f9; border-radius:5px;">
                    <div>
                        <strong style="color:#cb686b;">/${cmd.name}</strong>
                        <div style="font-size:0.8em; color:#666;">${cmd.description || "No description"}</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" ${cmd.enabled ? "checked" : ""} 
                               onchange="toggleCommand('${cmd.name}', this)">
                        <span class="slider round"></span>
                    </label>
                </div>
            `,
              )
              .join("");
          } else {
            listEl.innerHTML = "<p>No commands found.</p>";
          }
        } catch (err) {
          listEl.innerHTML = `<p style="color: red;">Error: ${err.message}</p>`;
        }
      }

      async function resetScore(gameKey, gameName) {
        if (
          !confirm(
            `‚ö†Ô∏è WARNING: Are you sure you want to reset your ${gameName} wins?\n\nThis action is NOT reversible  !`,
          )
        ) {
          return;
        }

        const token = localStorage.getItem("session");
        try {
          const response = await fetch(`${TUNNEL_URL}/api/reset-score`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-requested-with": "TheLunarArchive-Dashboard",
              Authorization: token,
              "ngrok-skip-browser-warning": "true",
            },
            body: JSON.stringify({ gameKey: gameKey }),
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || "Failed to reset score.");
          }

          alert(`${gameName} wins have been reset to 0.`);
          location.reload();
        } catch (err) {
          alert(`‚õî Error: ${err.message}`);
        }
      }

      window.onload = async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get("code");
        const token = localStorage.getItem("session");

        if (code) {
          try {
            const res = await fetch(`${TUNNEL_URL}/api/login`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "x-requested-with": "TheLunarArchive-Dashboard",
              },
              body: JSON.stringify({ code }),
            });
            const data = await res.json();
            if (data.token) {
              localStorage.setItem("session", data.token);
              window.location.href = window.location.pathname;
            } else {
              throw new Error(data.error || "Login failed.");
            }
          } catch (err) {
            document.getElementById("status").innerText = err.message;
          }
        } else if (token) {
          fetch(`${TUNNEL_URL}/api/get-settings`, {
            headers: {
              "x-requested-with": "TheLunarArchive-Dashboard",
              Authorization: token,
              "ngrok-skip-browser-warning": "true",
            },
          })
            .then(async (res) => {
              if (!res.ok) {
                const errorData = await res.json().catch(() => ({}));
                const errorMessage =
                  errorData.error ||
                  `An unexpected error occurred (Status: ${res.status})`;
                const err = new Error(errorMessage);
                err.status = res.status;
                throw err;
              }
              return res;
            })
            .then(handle)
            .then((data) => {
              document.getElementById("status").style.display = "none";
              document.getElementById("settingsArea").style.display = "block";
              document.getElementById("userName").innerText = data.username;
              document.getElementById("userAvatar").src = data.avatar;
              document.getElementById("displayUserId").innerText = data.userId;
              document.getElementById("wsWins").innerText = data.stats.ws_wins;
              document.getElementById("snWins").innerText = data.stats.sn_wins;
              document.getElementById("tttWins").innerText =
                data.stats.ttt_wins;
              document.getElementById("rpsWins").innerText =
                data.stats.rps_wins;
              document.getElementById("mmWins").innerText = data.stats.mm_wins;
              document.getElementById("c4Wins").innerText = data.stats.c4_wins;
              document.getElementById("ws_hidden").checked =
                data.stats.ws_hidden;
              document.getElementById("sn_hidden").checked =
                data.stats.sn_hidden;
              document.getElementById("ttt_hidden").checked =
                data.stats.ttt_hidden;
              document.getElementById("rps_hidden").checked =
                data.stats.rps_hidden;
              document.getElementById("mm_hidden").checked =
                data.stats.mm_hidden;
              document.getElementById("c4_hidden").checked =
                data.stats.c4_hidden;
              document.getElementById("dm_reply").checked = data.stats.dm_reply;

              if (data.adminGuilds?.length > 0) {
                allAdminGuilds = data.adminGuilds;
                const select = document.getElementById("guildSelector");
                select.innerHTML = "";
                data.adminGuilds.forEach((guild) => {
                  const opt = document.createElement("option");
                  opt.value = guild.id;
                  opt.innerText = guild.name;
                  select.appendChild(opt);
                });
                document.getElementById("guildSelectorArea").style.display =
                  "flex";
                document.getElementById("adminStatus").innerText =
                  "Managing your servers successfully.";
                updateSelectedGuild();
                loadCommands();
              } else {
                document.getElementById("adminStatus").innerText =
                  "No admin servers found.";
              }
            })
            .catch((err) => {
              console.error("Caught Error:", err);
              const statusEl = document.getElementById("status");

              if (err.status === 401) {
                statusEl.innerText = "Session invalid. Please log in again.";
                document.getElementById("loginBtn").style.display = "block";
                localStorage.removeItem("session");
              } else if (err.status === 429) {
                statusEl.innerText =
                  "Too many requests. Please try again later.";
              } else {
                statusEl.innerText = `‚õî ${err.message}`;
                //alert(`‚õî ${err.message}`);
              }
            });
        } else {
          document.getElementById("status").innerText = "Please log in.";
          document.getElementById("loginBtn").style.display = "block";
          document.getElementById("loginBtn").onclick = () =>
            (window.location.href = DISCORD_LOGIN_URL);
        }
      };
    </script>
  </body>
</html>
