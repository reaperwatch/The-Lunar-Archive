<!doctype html>
<html>
  <head>
    <title>Bot Test Dashboard</title>
  </head>
  <body>
    <h1>My Bot Dashboard</h1>
    <div id="status">Checking login...</div>

    <button id="loginBtn" style="display: none">Login with Discord</button>

    <div id="settingsArea" style="display: none">
      <hr />
      <h3>Welcome Back!</h3>
      <p>User ID: <span id="displayUserId"></span></p>

      <div
        id="statsDisplay"
        style="
          background: #f4f4f4;
          padding: 15px;
          border-radius: 8px;
          margin-top: 10px;
        "
      >
        <h4>Your Game Stats</h4>
        <p>üêç Snake Wins: <b id="snWins">0</b></p>
        <p>‚ùå Tic-Tac-Toe Wins: <b id="tttWins">0</b></p>
        <p>‚úÇÔ∏è RPS Wins: <b id="rpsWins">0</b></p>
        <p>üß† Memory Matching Wins: <b id="mmWins">0</b></p>
      </div>

      <div
        id="adminArea"
        style="margin-top: 20px; border-top: 2px solid #ddd; padding-top: 10px"
      >
        <h4>Guild Settings (Admin Only)</h4>
        <p id="adminStatus">Checking permissions...</p>
        <div id="prefixControls" style="display: none">
          <label>Server Prefix:</label>
          <input
            type="text"
            id="prefixInput"
            maxlength="3"
            style="width: 40px"
          />
          <button onclick="savePrefix()">Save Prefix</button>
          <p id="saveStatus"></p>
        </div>
      </div>

      <br />
      <button
        onclick="logout()"
        style="
          background-color: #ff4444;
          color: white;
          border: none;
          padding: 10px;
          cursor: pointer;
        "
      >
        Log Out
      </button>
    </div>

    <script>
      const TUNNEL_URL = "https://instructively-hushful-cinda.ngrok-free.dev";
      const DISCORD_LOGIN_URL =
        "https://discord.com/oauth2/authorize?client_id=1048675302722768896&response_type=code&redirect_uri=https%3A%2F%2Freaperwatch.github.io%2FThe-Lunar-Archive%2Fdashboard.html&scope=identify%20guilds";

      function logout() {
        localStorage.removeItem("session");
        window.location.href = window.location.pathname; // Clean URL
      }

      async function savePrefix() {
        const token = localStorage.getItem("session");
        const newPrefix = document.getElementById("prefixInput").value;
        const status = document.getElementById("saveStatus");

        if (!window.currentGuildId) return;

        status.innerText = "Saving...";
        try {
          const response = await fetch(`${TUNNEL_URL}/api/save-prefix`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: token,
            },
            body: JSON.stringify({
              guildId: window.currentGuildId,
              newPrefix: newPrefix,
            }),
          });

          if (response.ok) {
            status.innerText = "‚úÖ Prefix updated!";
          } else {
            status.innerText = "‚ùå Failed to save.";
          }
        } catch (err) {
          status.innerText = "‚ùå Bot connection error.";
        }
      }

      window.onload = async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get("code");

        // If we just got redirected from Discord with a code
        if (code) {
          document.getElementById("status").innerText = "Verifying login...";
          try {
            const response = await fetch(`${TUNNEL_URL}/api/login`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ code: code }),
            });
            const data = await response.json();

            if (data.token) {
              localStorage.setItem("session", data.token);
              window.history.replaceState(
                {},
                document.title,
                window.location.pathname,
              ); // Clean URL
              window.location.reload(); // Refresh
            }
          } catch (err) {
            document.getElementById("status").innerText =
              "Connection error. Is the bot/ngrok running?";
          }
        }

        // If we are already logged in check LocalStorage
        else {
          const token = localStorage.getItem("session");
          if (!token) {
            document.getElementById("status").innerText = "Please log in.";
            document.getElementById("loginBtn").style.display = "block";
            document.getElementById("loginBtn").onclick = () =>
              (window.location.href = DISCORD_LOGIN_URL);
          } else {
            // SHOW DASHBOARD
            document.getElementById("status").style.display = "none";
            document.getElementById("settingsArea").style.display = "block";

            // Fetch Settings
            fetch(`${TUNNEL_URL}/api/get-settings`, {
              headers: { Authorization: token },
            })
              .then((res) => res.json())
              .then((data) => {
                if (data.userId) {
                  document.getElementById("displayUserId").innerText =
                    data.userId;

                  // Fill Stats
                  document.getElementById("snWins").innerText =
                    data.stats.sn_wins;
                  document.getElementById("tttWins").innerText =
                    data.stats.ttt_wins;
                  document.getElementById("rpsWins").innerText =
                    data.stats.rps_wins;
                  document.getElementById("mmWins").innerText =
                    data.stats.mm_wins;

                  // Admin Logic
                  const adminArea = document.getElementById("prefixControls");
                  const statusLabel = document.getElementById("adminStatus");

                  if (data.adminGuilds && data.adminGuilds.length > 0) {
                    statusLabel.innerText =
                      "You can manage the following server(s): " +
                      data.adminGuilds.map((g) => g.name).join(", ");
                    adminArea.style.display = "block";

                    // Load first guild for now
                    document.getElementById("prefixInput").value =
                      data.adminGuilds[0].prefix;
                    window.currentGuildId = data.adminGuilds[0].id;
                  } else {
                    statusLabel.innerText =
                      "No servers found where you have Admin permissions.";
                  }
                } else {
                  logout(); // Invalid token
                }
              })
              .catch(() => {
                document.getElementById("status").innerText = "Bot is offline.";
                document.getElementById("status").style.display = "block";
              });
          }
        }
      };
    </script>
  </body>
</html>
